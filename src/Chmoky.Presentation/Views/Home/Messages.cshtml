@{
    ViewBag.Title = "Messages";
}
<h2 id="h2Title">@ViewBag.Title</h2>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-6">
            <h5 id="h5participants">Participants: <span id="participants"></span></h5>
            <h5>Messages Count: <span id="count"></span></h5>
            <h5>Messages Length: <span id="length"></span></h5>
        </div>
        <div class="col-lg-6">
            <h5>Min Message: <span id="min"></span></h5>
            <h5>Max Message: <span id="max"></span></h5>
            <h5>Avg Message: <span id="avg"></span></h5>
        </div>
    </div>
</div>

<div class="table-responsive">
    <div class="fixed-table-toolbar">
        <div class="bars pull-left">
            <div id="header-toolbar">
                <button type="button" class="btn btn-default " id="next">Next</button>
                <button type="button" class="btn btn-primary " id="current">Current</button>
                <button type="button" class="btn btn-default " id="previous">Previous</button>
            </div>
        </div>
    </div>
    <table class="table table-hover table-striped"
           id="messages"
           data-toggle="table"
           data-query-params="postQueryParams"
           data-method="post"
           data-content-type="application/x-www-form-urlencoded"
           data-side-pagination="server"
           data-pagination="true"
           data-page-size="10"
           data-page-list="[10, 20, 50, 100, 200]"
           data-sort-order="asc"
           data-sort-name="timestamp"
           data-striped="true"
           data-show-loading="true"
           data-cache="false">
        <thead>
            <tr>
                <th data-field="RowNum" data-halign="center">#</th>
                <th data-field="row" data-halign="center" data-formatter="textFormatter">Message</th>
                <th data-field="timestamp" data-formatter="dateFormatter" data-sortable="true" data-halign="center" data-align="center">Time</th>
                <th data-field="len" data-formatter="numberFormatter" data-sortable="true" data-align="right" data-halign="center">Len</th>
            </tr>
        </thead>
    </table>
</div>

@section scripts
{
    <script src="~/Scripts/date.js"></script>
    <script src="~/Scripts/common.js"></script>
    <script>
        var selectedMonth = Date.today().add(-1).month();

        $messages = $('#messages');

        function changeButtonsCaptions() {
            $('#current').html("Messages for " + getCaptionFromDate(selectedMonth));
            $('#previous').html(getCaptionFromDate(new Date(selectedMonth).add(-1).month()));
            $('#next').html(getCaptionFromDate(new Date(selectedMonth).add(1).month()));
        }

        function postQueryParams(params) {
            var urlVars = getUrlVars();
            var author = urlVars['author'];
            params.currentDate = selectedMonth.toString("yyyy-MM-dd HH:mm");
            params.author = author;
            return params;
        }

        function getAuthorDetails(author) {
            $.ajax({
                url: "/Home/GetAuthorDetails/",
                type: "POST",
                data: { author: author },
                dataType: "html",
                success: function (result, status, xhr) {
                    var json = $.parseJSON(result);
                    if (json.FullName != undefined) {
                        $('#h2Title').text("Messages of " + json.FullName);
                    }
                    if (json.SkypeID != undefined) {
                        $('#h5participants').text("Skype ID: " + json.SkypeID);
                    }
                    else {
                        $('#h5participants').text("Skype ID: " + author);
                    }
                },
                error: function (xhr, status, error) {
                    $('#h5participants').text("Skype ID: " + author);
                }
            });
        }

        function setUrlVars() {
            if (history.pushState) {
                var options = $messages.bootstrapTable('getOptions');
                params = postQueryParams(options);
                var author = '';
                if (params.author != undefined) {
                    author = 'author=' + params.author + '&';
                }
                var query = author
                    + 'month=' + params.currentDate.substring(0, 7)
                    + '&sortName=' + params.sortName
                    + '&sortOrder=' + params.sortOrder
                    + '&page=' + params.pageNumber
                    + '&size=' + params.pageSize;
                var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + query;
                window.history.pushState({ path: newurl }, '', newurl);
            }
        }

        function setTableOptionsByUrlVars() {
            var urlVars = getUrlVars();
            var month = urlVars['month'];
            var page = urlVars['page'];
            var size = urlVars['size'];
            var sort = urlVars['sortName'];
            var order = urlVars['sortOrder'];

            if (month != undefined) {
                var currentMonth = new Date(month + "-01");
                if (!isNaN(currentMonth)) selectedMonth = currentMonth;
            }

            validateAndSetTableOptions($messages, page, size, sort, order);
        }

        function setParticipantsByUrlVars() {
            var urlVars = getUrlVars();
            var author = urlVars['author'];
            if (author != undefined) {
                getAuthorDetails(author);
            }
        }

        function textFormatter(value, row, index) {
            var authorName = row.Author.FullName;
            if (authorName == " ") {
                authorName = row.Author.SkypeID;
            }
            var author = '<a data-toggle="popover" data-trigger="hover" onclick="onAuthorClick(\'' + encode(row.Author.SkypeID) + '\')" data-content="'
                + row.Author.SkypeNames + '" title= "Skype Name" data-html="true" class="" >' + authorName + '</a>';
            var message = '<div class="messagesText">' + row.text + '</div>';
            return author + '<br/>' + message;
        }

        function dateFormatter(value) {
            if (value === null) return null;
            var date = new Date(parseInt(value.substr(6)));
            return date.toString("dd/MM/yy HH:mm");
        }

        $(document).ready(function () {
            $messages
                .on('all.bs.table', function (e, name, args) {
                    $('[data-toggle="tooltip"]').tooltip();
                    $('[data-toggle="popover"]').popover();
                })
                .on('load-success.bs.table', function (e, data) {
                    if ($('#participants').length == 1) {
                        $('#participants').html(numberFormatter(data.participants));
                    }
                    $('#length').html(numberFormatter(data.textLength));
                    $('#count').html(numberFormatter(data.count));
                    $('#min').html(numberFormatter(data.min));
                    $('#max').html(numberFormatter(data.max));
                    $('#avg').html(numberFormatter(data.avg));
                    setUrlVars();
                    changeButtonsCaptions();
                });

            $('#previous').click(function () {
                selectedMonth = new Date(selectedMonth).add(-1).month();
                $messages.bootstrapTable('refresh');
            });

            $('#next').click(function () {
                selectedMonth = new Date(selectedMonth).add(1).month();
                $messages.bootstrapTable('refresh');
            });

            setParticipantsByUrlVars();
            setTableOptionsByUrlVars();
            changeButtonsCaptions();

            $messages.bootstrapTable('refresh', { url: "/Home/GetMessages" });
        });
    </script>
}